<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPSU | Student Org Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --cpsu-green-dark: #081c15;
            --cpsu-green: #2d6a4f;
            --cpsu-green-mid: #40916c;
            --cpsu-green-light: #d8f3dc;
            --earth-light: #f8faf9;
            --gold: #b08d57;
            --gold-light: #d4af37;
            --white: #ffffff;
            --danger: #ef4444;
            --sidebar-width: 280px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: url('CPSU LOGO.png'); 
            background-size: cover; 
            background-position: center; 
            color: var(--cpsu-green-dark); 
            min-height: 100vh; 
            overflow-x: hidden;
            line-height: 1.6;
        }

        #login-page {
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            position: fixed; 
            width: 100%; 
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        .login-bg {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, rgba(27, 67, 50, 0.85), rgba(8, 28, 21, 0.95)), url('CPSU LOGO.png');
            background-size: cover; 
            background-position: center; 
            z-index: -1;
        }

        .login-card { 
            background: rgba(255, 255, 255, 0.98); 
            padding: 3rem 2.5rem; 
            border-radius: 24px; 
            text-align: center; 
            width: 90%; 
            max-width: 440px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .auth-toggle-container {
            display: flex; 
            background: #f1f5f9; 
            border-radius: 12px; 
            margin: 2rem 0; 
            padding: 4px;
        }
        .auth-btn {
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: all 0.3s ease; 
            font-size: 0.9rem;
        }
        .auth-btn.active { 
            background: var(--white); 
            color: var(--cpsu-green); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        #main-dashboard { 
            display: none; 
            min-height: 100vh; }
        
        nav { 
            width: var(--sidebar-width); 
            background: var(--cpsu-green-dark); 
            color: white; 
            padding: 2rem 1.2rem; 
            position: fixed; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 1000;
        }
        nav.collapsed { transform: translateX(-100%); }

        .nav-brand { 
            font-size: 1.4rem; 
            font-weight: 800; 
            color: var(--white); 
            margin-bottom: 3rem; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            padding-left: 10px;
        }
        .nav-brand i { color: var(--gold-light); }

        .nav-link { 
            padding: 14px 18px; color: #a3b18a; text-decoration: none; 
            border-radius: 12px; margin-bottom: 0.8rem; cursor: pointer; 
            transition: 0.3s; display: flex; align-items: center; gap: 14px; 
            font-weight: 500;
        }
        .nav-link:hover { color: var(--white); background: rgba(255,255,255,0.05); }
        .nav-link.active { background: var(--cpsu-green); color: var(--white); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        main { flex: 1; margin-left: var(--sidebar-width); padding: 2rem 3rem; transition: 0.4s ease; width: calc(100% - var(--sidebar-width)); }
        main.full-width { margin-left: 0; width: 100%; }

        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .top-bar { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 3rem; 
            background: white; padding: 1rem 1.5rem;
            border-radius: var(--radius); 
            box-shadow: var(--shadow);
        }
        
        #toggle-btn { 
            background: #f1f5f9; 
            color: var(--cpsu-green-dark); 
            border: none; 
            width: 45px; 
            height: 45px; 
            border-radius: 10px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.3s;
        }
        #toggle-btn:hover { background: var(--cpsu-green-light); color: var(--cpsu-green); }

        .search-wrapper { position: relative; width: 300px; }
        .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-wrapper input { padding: 10px 15px 10px 45px; margin: 0; background: #f8fafc; border: 1px solid #e2e8f0; }

        .club-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; }
        .club-card { 
            background: white; padding: 2.5rem 2rem; border-radius: 24px; 
            box-shadow: var(--shadow); border: 1px solid #f1f5f9;
            transition: all 0.4s ease; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .club-card:hover { transform: translateY(-12px); border-color: var(--cpsu-green-mid); }
        .club-card::after { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; 
            background: var(--gold-light); transition: 0.3s;
        }
        .club-card:hover::after { background: var(--cpsu-green); }

        .org-logo-container {
            width: 110px; height: 110px; margin: 0 auto 1.5rem;
            display: flex; justify-content: center; align-items: center;
            background: #f8fafc; 
            border-radius: 50%; 
            border: 3px solid #f1f5f9; 
            transition: 0.3s;
            overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .club-card:hover .org-logo-container { 
            border-color: var(--cpsu-green); 
            transform: scale(1.05);
        }
        
        .org-logo-img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        h3 { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--cpsu-green-dark); }
        .org-description { font-size: 0.9rem; color: #64748b; margin: 1rem 0 2rem; min-height: 80px; }

        input, select, textarea { 
            width: 100%; padding: 14px 18px; margin: 10px 0; 
            border: 1px solid #e2e8f0; border-radius: 12px; 
            font-family: inherit; font-size: 0.95rem; transition: 0.3s;
        }
        input:focus { outline: none; border-color: var(--cpsu-green); background: white; box-shadow: 0 0 0 4px rgba(45, 106, 79, 0.1); }

        button { font-family: 'Plus Jakarta Sans', sans-serif; cursor: pointer; transition: 0.3s; }
        .btn-primary { 
            background: var(--cpsu-green); color: white; border: none; 
            padding: 14px 24px; border-radius: 12px; font-weight: 700; width: 100%;
        }
        .btn-primary:hover { background: var(--cpsu-green-dark); transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(45, 106, 79, 0.4); }
        
        .status-badge {
            padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            background: var(--cpsu-green-light); color: var(--cpsu-green);
        }

        #modal-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(8, 28, 21, 0.6); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 3000; 
        }
        .modal-form { 
            background: white; padding: 3rem; border-radius: 24px; 
            width: 95%; max-width: 550px; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.3);
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 1rem; }
        th { padding: 15px; text-align: left; color: #64748b; font-weight: 600; font-size: 0.85rem; }
        td { padding: 20px 15px; background: white; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        td:first-child { border-left: 1px solid #f1f5f9; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        td:last-child { border-right: 1px solid #f1f5f9; border-top-right-radius: 12px; border-bottom-right-radius: 12px; }

        .btn-delete { background: #fee2e2; color: var(--danger); border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; }
        .btn-delete:hover { background: var(--danger); color: white; }

        @media (max-width: 768px) {
            main { padding: 1.5rem; margin-left: 0; width: 100%; }
            nav { width: 0; display: none; }
        }
    </style>
</head>
<body>

    <section id="login-page">
        <div class="login-bg"></div>
        <div class="login-card">
            <div style="background: var(--cpsu-green); width: 70px; height: 70px; border-radius: 20px; margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.8rem; box-shadow: 0 10px 20px rgba(45,106,79,0.3);">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1 style="font-weight: 800; letter-spacing: -1px; font-size: 2rem;">Welcome Back</h1>
            <p style="color: #64748b; font-size: 0.9rem; margin-top: 5px;">Access your student organization portal</p>
            
            <div class="auth-toggle-container">
                <button class="auth-btn active" id="mode-login" onclick="setAuthMode('login')">Log In</button>
                <button class="auth-btn" id="mode-register" onclick="setAuthMode('register')">Register</button>
            </div>

            <form id="db-auth-form">
                <div id="name-field-container" style="display: none;">
                    <input type="text" id="auth-name" placeholder="Enter Full Name">
                </div>
                <input type="email" id="auth-email" placeholder="Email Address (e.g. name@student.com)" required>
                <button type="submit" id="submit-btn" class="btn-primary" style="margin-top: 15px;">Continue</button>
                <p id="auth-error" style="color: var(--danger); font-size: 0.85rem; margin-top: 15px; display: none; background: #fff1f2; padding: 10px; border-radius: 8px;"></p>
            </form>
        </div>
    </section>

    <div id="main-dashboard">
        <nav id="sidebar">
            <div class="nav-brand">
                <i class="fas fa-leaf"></i>
                <span>CPSU PORTAL</span>
            </div>
            <div class="nav-link active" onclick="showPage('clubs')">
                <i class="fas fa-th-large"></i> <span>Organizations</span>
            </div>
            <div class="nav-link" onclick="showPage('pending')">
                <i class="fas fa-clock-rotate-left"></i> <span>My Activity</span>
            </div>
            <div class="nav-link" onclick="showPage('admin')">
                <i class="fas fa-user-shield"></i> <span>Member Directory</span>
            </div>
            
            <div style="margin-top: auto; padding-top: 2rem;">
                <button onclick="handleLogout()" style="width: 100%; padding: 12px; background: rgba(239, 68, 68, 0.1); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; font-weight: 600;">
                    <i class="fas fa-right-from-bracket"></i> &nbsp; Logout
                </button>
            </div>
        </nav>

        <main id="main-content">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button id="toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars-staggered"></i></button>
                    <div>
                        <p style="font-size: 0.8rem; color: #64748b; font-weight: 600;">STUDENT DASHBOARD</p>
                        <h2 style="font-size: 1.1rem; font-weight: 800;">Hello, <span id="user-display-name" style="color: var(--cpsu-green);">Student</span>!</h2>
                    </div>
                </div>
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search..." onkeyup="filterOrgs(this.value)">
                </div>
            </div>

            <section id="clubs" class="page active">
                <div style="margin-bottom: 2rem;">
                    <h2 style="font-size: 1.8rem; font-weight: 800;">Discover Clubs</h2>
                    <p style="color: #64748b;">Find your community and grow your skills</p>
                </div>
                <div class="club-grid" id="org-container"></div>
            </section>

            <section id="pending" class="page">
                <div style="margin-bottom: 2rem;">
                    <h2 style="font-size: 1.8rem; font-weight: 800;">My Activity History</h2>
                    <p style="color: #64748b;">Track the status of your organization applications</p>
                </div>
                <div id="tempAppList" style="display: grid; gap: 15px;"></div>
            </section>

            <section id="admin" class="page">
                <div style="background: white; padding: 2rem; border-radius: 24px; box-shadow: var(--shadow);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 800;">Member Directory</h2>
                        <button onclick="fetchUsers()" style="background: none; border: none; color: var(--cpsu-green); font-weight: 700;"><i class="fas fa-sync"></i> Refresh List</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr><th>MEMBER ID</th><th>FULL NAME</th><th>EMAIL</th><th style="text-align: right;">ACTIONS</th></tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-overlay">
        <div class="modal-form">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                <div>
                    <h2 id="modal-title" style="font-size: 1.5rem; font-weight: 800;">Join Organization</h2>
                    <p style="color: #64748b; font-size: 0.9rem;">Fill out the details below to apply.</p>
                </div>
                <button onclick="closeModal()" style="background: #f1f5f9; border: none; width: 35px; height: 35px; border-radius: 50%;">&times;</button>
            </div>
            
            <form id="app-form">
                <input type="hidden" id="form-org-name">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.8rem; font-weight: 700; color: #64748b;">FIRST NAME</label>
                        <input type="text" id="app-fname" placeholder="John" required>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; font-weight: 700; color: #64748b;">LAST NAME</label>
                        <input type="text" id="app-lname" placeholder="Doe" required>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.8rem; font-weight: 700; color: #64748b;">YEAR LEVEL</label>
                        <select id="app-year" required>
                            <option value="" disabled selected>Select Year</option>
                            <option>1st Year</option><option>2nd Year</option>
                            <option>3rd Year</option><option>4th Year</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; font-weight: 700; color: #64748b;">COURSE</label>
                        <input type="text" id="app-course" placeholder="BSIT" required>
                    </div>
                </div>
                <div>
                    <label style="font-size: 0.8rem; font-weight: 700; color: #64748b;">STATEMENT OF INTEREST</label>
                    <textarea id="app-reason" rows="4" placeholder="Why do you want to join?" required></textarea>
                </div>
                <div style="margin-top: 2rem;">
                    <button type="submit" class="btn-primary">Submit Application</button>
                </div>
            </form>
        </div>
    </div>

<script>
    const API_URL = 'https://cpsuorghub-production.up.railway.app/api/users';
    let currentAuthMode = 'login';

    const orgData = [
        { name: "SSG", logo: "SSG.jpg", isImage: true, description: "The Supreme Student Government represents the student body and leads campus-wide initiatives for student welfare." }, 
        { name: "CSS", logo: "CSS.jpg", isImage: true, description: "The Crimonology Student Society organization fosters discipline, integrity, and leadership for future law enforcers." },
        { name: "FLP", logo: "FLP.jpg", isImage: true, description: "Future Leaders of the Philippines focuses on developing patriotism and character among student leaders." },
        { name: "INFOTECH ORG", logo: "INFOTECH.jpg", isImage: true, description: "Building a community for IT enthusiasts to share knowledge, innovation, and technical expertise in technology." }, 
        { name: "PEER SUPPORT", logo: "PEER.jpg", isImage: true, description: "Dedicated to promoting mental health awareness and providing a compassionate support system for every student." },
        { name: "CAFFO", logo: "CAFFO.jpg", isImage: true, description: "Promoting excellence in Agriculture and Forestry through research, sustainability, and community farming." }, 
        { name: "COMRADES", logo: "COMRADES.jpg", isImage: true, description: "Developing discipline and camaraderie through leadership training and civic-military student involvement." },
        { name: "RED CROSS", logo: "REDCROSS.jpg", isImage: true, description: "Fostering humanitarian values and providing health and safety training for campus emergency response." }, 
        { name: "CCYO", logo: "CCYO.jpg", isImage: true, description: "A spiritual home for Catholic youth to grow in faith, moral values, and community service." },
        { name: "FIBO", logo: "FIBO.jpg", isImage: true, description: "Dedicated to the advancement of biological sciences and environmental research among biology majors." }, 
        { name: "PATAPAS ORG", logo: "PATAPAS.jpg", isImage: true, description: "The PATAPAS Organization is a specialized group dedicated to the advancement of the sugarcane industryâ€”the lifeblood of the region." },
        { name: "EDSOC", logo: "EDSOC.png", isImage: true, description: "Empowering future educators with the professional skills and academic excellence needed in the teaching field." }, 
        { name: "ASSC", logo: "ASSC.jpg", isImage: true, description: "Representing the Arts and Sciences students, promoting critical thinking and artistic expression." },
        { name: "AGRIBUSINESS", logo: "AGRIBUSINESS.jpg", isImage: true, description: "Bridging the gap between agricultural production and commercial entrepreneurship for modern farmers." }, 
        { name: "JPSTECH", logo: "JPSTECH.jpg", isImage: true, description: "The organization for industrial technology students, advancing technical skills and industrial innovations." }
    ];

    /* --- SESSION PERSISTENCE --- */
    window.onload = () => {
        const savedUser = localStorage.getItem('cpsu_user_name');
        if (savedUser) {
            enterDashboard(savedUser, true); 
        }
    };

    /* --- AUTHENTICATION LOGIC --- */
    function setAuthMode(mode) {
        currentAuthMode = mode;
        document.getElementById('auth-error').style.display = 'none';
        document.getElementById('mode-login').classList.toggle('active', mode === 'login');
        document.getElementById('mode-register').classList.toggle('active', mode === 'register');
        document.getElementById('name-field-container').style.display = (mode === 'register') ? 'block' : 'none';
        document.getElementById('submit-btn').innerText = (mode === 'register') ? 'Create Account' : 'Log In';
    }

    document.getElementById('db-auth-form').onsubmit = async (e) => {
        e.preventDefault();
        const name = document.getElementById('auth-name').value.trim();
        const email = document.getElementById('auth-email').value.trim();
        try {
            const response = await fetch(`${API_URL}/display`);
            const users = await response.json();
            const existingUser = users.find(u => u.email.toLowerCase() === email.toLowerCase());

            if (currentAuthMode === 'login') {
                if (existingUser) { enterDashboard(existingUser.name); } 
                else { showAuthError("Email not found. Please register first."); }
            } else {
                if (existingUser) { showAuthError("Email is already registered."); } 
                else {
                    const regRes = await fetch(`${API_URL}/users`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name, email })
                    });
                    if (regRes.ok) { enterDashboard(name); } 
                    else { showAuthError("Registration failed. Try again."); }
                }
            }
        } catch (err) { alert("Database Connection Error."); }
    };

    function showAuthError(msg) {
        const errorLabel = document.getElementById('auth-error');
        errorLabel.innerText = msg;
        errorLabel.style.display = 'block';
    }

    function enterDashboard(displayName, isRefresh = false) {
        // Save to browser memory
        localStorage.setItem('cpsu_user_name', displayName);
        document.getElementById('user-display-name').innerText = displayName;
        
        if (isRefresh) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'flex';
            initDashboard();
        } else {
            document.getElementById('login-page').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'flex';
                initDashboard();
            }, 300);
        }
    }

    function handleLogout() {
        if(confirm("Are you sure you want to logout?")) {
            localStorage.removeItem('cpsu_user_name');
            location.reload();
        }
    }

    /* --- UI NAVIGATION --- */
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('main-content').classList.toggle('full-width');
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
    }

    /* --- DASHBOARD INITIALIZATION --- */
    function initDashboard() {
        renderOrgs(orgData);
        fetchUsers();
        injectEditModal(); 
    }

    function renderOrgs(data) {
        const container = document.getElementById('org-container');
        container.innerHTML = data.map(org => {
            const logoHtml = `<img src="${org.logo}" class="org-logo-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1041/1041916.png'">`;
            return `
                <div class="club-card">
                    <div class="org-logo-container">${logoHtml}</div>
                    <div style="text-align: center;">
                        <h3>${org.name}</h3>
                        <span class="status-badge">Official Org</span>
                        <p class="org-description">${org.description}</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('${org.name}')">Apply to Join</button>
                </div>
            `;
        }).join('');
    }

    /* --- MEMBER DIRECTORY (CRUD LOGIC) --- */
    async function fetchUsers() {
        try {
            const response = await fetch(`${API_URL}/display`);
            const users = await response.json();
            document.getElementById('tableBody').innerHTML = users.map(user => `
                <tr>
                    <td><span style="font-family: monospace; font-weight: 700; color: #16a34a;">#CPSU-${user.id}</span></td>
                    <td><div style="font-weight: 700;">${user.name}</div></td>
                    <td style="color: #64748b;">${user.email}</td>
                    <td style="text-align: right; display: flex; gap: 8px; justify-content: flex-end;">
                        <button onclick="openEditModal(${user.id}, '${user.name}', '${user.email}')" style="background: #fef3c7; color: #f59e0b; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete" onclick="deleteUser(${user.id})" style="background: #fee2e2; color: #ef4444; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch(e) { console.error("Fetch error:", e); }
    }

    async function deleteUser(id) {
        if (confirm('Are you sure you want to remove this member?')) {
            try {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                fetchUsers();
            } catch (err) { alert("Error deleting user."); }
        }
    }

    /* --- EDIT MODAL & DATABASE UPDATE --- */
    function injectEditModal() {
        if (!document.getElementById('edit-modal-overlay')) {
            const modalHtml = `
                <div id="edit-modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
                    <div style="background:white; padding:2rem; border-radius:16px; width:90%; max-width:400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
                        <h2 style="margin-bottom:1.5rem; color:#166534;">Edit Member</h2>
                        <form id="edit-user-form">
                            <input type="hidden" id="edit-user-id">
                            <label style="display:block; margin-bottom:5px; font-weight:600;">Full Name</label>
                            <input type="text" id="edit-user-name" required style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
                            <label style="display:block; margin-bottom:5px; font-weight:600;">Email Address</label>
                            <input type="email" id="edit-user-email" required style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ddd; border-radius:8px;">
                            <button type="submit" id="save-edit-btn" style="width:100%; padding:12px; background:#166534; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600;">Save Changes</button>
                            <button type="button" onclick="closeEditModal()" style="width:100%; margin-top:10px; background:none; border:none; color:#64748b; cursor:pointer;">Cancel</button>
                        </form>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('edit-user-form').onsubmit = async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('save-edit-btn');
                const id = document.getElementById('edit-user-id').value;
                const name = document.getElementById('edit-user-name').value;
                const email = document.getElementById('edit-user-email').value;

                saveBtn.innerText = "Saving...";
                saveBtn.disabled = true;

                try {
                    const response = await fetch(`${API_URL}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email })
                    });

                    if (response.ok) {
                        closeEditModal(); 
                        fetchUsers();
                    } else {
                        alert("Update failed. Please check the API configuration.");
                    }
                } catch (err) {
                    console.error("Update Error:", err);
                    alert("Connection error while saving changes.");
                } finally {
                    saveBtn.innerText = "Save Changes";
                    saveBtn.disabled = false;
                }
            };
        }
    }

    function openEditModal(id, name, email) {
        document.getElementById('edit-user-id').value = id;
        document.getElementById('edit-user-name').value = name;
        document.getElementById('edit-user-email').value = email;
        document.getElementById('edit-modal-overlay').style.display = 'flex';
    }

    function closeEditModal() { 
        document.getElementById('edit-modal-overlay').style.display = 'none'; 
    }

    /* --- APPLICATION MODALS --- */
    function openModal(orgName) { 
        document.getElementById('modal-title').innerText = "Join " + orgName;
        document.getElementById('form-org-name').value = orgName;
        document.getElementById('modal-overlay').style.display = 'flex'; 
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
</script>
</body>
</html>